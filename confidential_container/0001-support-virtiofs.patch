From 37f45b783b9d7aa6d1ce6336bf2fb7392648a481 Mon Sep 17 00:00:00 2001
From: XiaoFeng Ma <maxiaofeng14@h-partners.com>
Date: Mon, 12 Aug 2024 17:30:35 +0800
Subject: [PATCH] support virtiofs

---
 src/runtime/pkg/govmm/qemu/qemu.go      | 12 ++++++++++++
 src/runtime/virtcontainers/virtiofsd.go |  9 +++++++--
 2 files changed, 19 insertions(+), 2 deletions(-)

diff --git a/src/runtime/pkg/govmm/qemu/qemu.go b/src/runtime/pkg/govmm/qemu/qemu.go
index 1470a3533..e2ae4e5c5 100644
--- a/src/runtime/pkg/govmm/qemu/qemu.go
+++ b/src/runtime/pkg/govmm/qemu/qemu.go
@@ -1589,9 +1589,21 @@ func (vhostuserDev VhostUserDevice) QemuFSParams(config *Config) []string {
 		deviceParams = append(deviceParams, fmt.Sprintf("romfile=%s", vhostuserDev.ROMFile))
 	}
 
+	if driver == "vhost-user-fs-pci" {
+		deviceParams = append(deviceParams, "iommu_platform=on")
+	}
+
 	qemuParams = append(qemuParams, "-device")
 	qemuParams = append(qemuParams, strings.Join(deviceParams, ","))
 
+	if driver == "vhost-user-fs-pci" {
+		qemuParams = append(qemuParams, "-object")
+		objParams := "memory-backend-file,id=mem,size=" + config.Memory.Size + ", mem-path=/dev/shm,share=on"
+		qemuParams = append(qemuParams, objParams)
+		qemuParams = append(qemuParams, "-numa")
+		qemuParams = append(qemuParams, "node,memdev=mem")
+	}
+
 	return qemuParams
 }
 
diff --git a/src/runtime/virtcontainers/virtiofsd.go b/src/runtime/virtcontainers/virtiofsd.go
index 3e02756eb..ff46691bd 100644
--- a/src/runtime/virtcontainers/virtiofsd.go
+++ b/src/runtime/virtcontainers/virtiofsd.go
@@ -186,9 +186,14 @@ func (v *virtiofsd) args(FdSocketNumber uint) ([]string, error) {
 		// Send logs to syslog
 		"--syslog",
 		// cache mode for virtiofsd
-		"--cache=" + v.cache,
+		"-o",
+		"cache=" + v.cache,
 		// shared directory tree
-		"--shared-dir=" + v.sourcePath,
+		"-o",
+		"source=" + v.sourcePath,
+		// Announce sub-mount points to the guest
+		"-o",
+		"announce_submounts",
 		// fd number of vhost-user socket
 		fmt.Sprintf("--fd=%v", FdSocketNumber),
 	}
-- 
2.27.0

